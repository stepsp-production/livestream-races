<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steps Production Co Player</title>

  <!-- Players -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://player.vimeo.com/api/player.js"></script>

  <!-- Fix favicon 404 -->
  <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230b0b0f'/%3E%3Cpolygon points='26,20 26,44 46,32' fill='%23e53935'/%3E%3C/svg%3E" />

  <style>
    :root{
      --btn-bg:#e53935; --btn-bg-h:#d32f2f; --btn-bg-a:#b71c1c; --btn-txt:#fff;
      --btn-ring:rgba(211,47,47,.28);
      --panel-bg:#0b0b0fbb; --panel-bd:#ffffff26;
      --accent:#40c4ff;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

    #playerContainer{position:relative;width:100vw;height:100vh}
    .videoFrame{position:absolute;top:0;right:0;width:100%;height:100%;background:#000;overflow:hidden}

    /* Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© â€” Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¨Ø­ÙˆØ§Ù Ù…Ø­Ø³Ù‘Ù†Ø© */
    #mainPreview{
      position:absolute;top:16px;right:20px;width:22%;height:24%;
      z-index:6;border:1px solid #fff2;border-radius:18px;cursor:pointer;
      transition:transform .18s,box-shadow .18s,width .18s,height .18s,top .18s,right .18s,left .18s,border-radius .18s
    }
    #mainPreview:hover{box-shadow:0 10px 30px #0008}
    #mainPreview video{display:block;width:100%;height:100%;object-fit:contain}

    /* split */
    .split #mainPreview{top:0;right:0;left:auto;width:50%;height:100%;border-radius:0;border-width:0;cursor:default}
    .split #activeCam{top:0;left:0;right:auto;width:50%;height:100%}
    .split.fill #mainPreview video,.split.fill #activeCam video{object-fit:cover}
    .split.fill #mainPreview iframe,.split.fill #activeCam iframe{position:absolute;inset:0;margin:auto;width:120%;height:120%}

    .main-full #mainPreview{top:0;right:0;width:100%;height:100%;z-index:7;border:0;border-radius:0;cursor:zoom-out}
    .main-full #activeCam{display:none}

    .hint{position:absolute;top:20px;right:20px;z-index:8;background:#000a;color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #fff2}
    .split .hint,.main-full .hint{display:none}

    /* panels */
    #utilityControls,#camControls,#globalControls,#syncStatus,#shortcutsBadge{
      position:absolute;z-index:10;display:flex;gap:8px;flex-wrap:wrap;transition:opacity .18s,transform .18s,top .18s,right .18s,left .18s
    }

    /* utilityControls: Ø¹Ø§Ø¯ÙŠ=Ø¹Ù…ÙˆØ¯ÙŠ ÙŠØ³Ø§Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© / ØªÙ‚Ø³ÙŠÙ…=Ø£ÙÙ‚ÙŠ Ø£Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ† */
    #utilityControls{background:transparent;padding:0;border-radius:12px;border:0;backdrop-filter:none;align-items:center;box-shadow:none}
    #utilityControls.vertical{flex-direction:column}
    #utilityControls.horizontal{flex-direction:row}
    #utilityControls .group{display:flex;gap:6px;align-items:center}
    .divider{width:1px;height:22px;background:var(--panel-bd);margin:0 4px;border-radius:2px}

    /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… â€” Ø¯Ø§Ø¦Ù…Ù‹Ø§ ÙÙˆÙ‚ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª */
    #globalControls{
      bottom:70px;left:50%;transform:translateX(-50%);
      background:var(--panel-bg);padding:10px;border-radius:14px;border:1px solid var(--panel-bd);
      backdrop-filter:blur(8px);align-items:center;min-width:320px;z-index:20
    }
    #globalControls.hidden{display:none}
    #scrub{-webkit-appearance:none;appearance:none;width:320px;height:6px;border-radius:999px;background:#ffffff30;outline:none;margin:0 8px}
    #scrub::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid #0006;cursor:pointer}
    #timeLabel{color:#fff;font-size:12px;min-width:108px;text-align:center}

    /* Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª */
    #camControls{
      bottom:14px;left:50%;transform:translateX(-50%);
      background:var(--panel-bg);padding:10px;border-radius:14px;border:1px solid var(--panel-bd);backdrop-filter:blur(8px);
      z-index:12;
    }

    /* Ø´Ø§Ø±Ø© Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª â€” Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± Ù…ÙØµÙˆÙ„Ø© */
    #shortcutsBadge{
      top:12px;left:12px;right:auto;gap:0;background:var(--panel-bg);color:#fff;border:1px solid var(--panel-bd);
      border-radius:999px;padding:6px 10px;font-size:10px;backdrop-filter:blur(6px)
    }

    /* sync badge â€” Ø¨Ù„Ø§ Ø¸Ù„ */
    #syncStatus{
      bottom:122px;left:50%;transform:translateX(-50%);background:#08131fcc;color:#e6f3ff;border:1px solid var(--panel-bd);
      padding:6px 10px;border-radius:10px;font-size:12px;align-items:center;gap:6px;box-shadow:none;z-index:14
    }
    #syncStatus.hidden{display:none}
    .dot{width:10px;height:10px;border-radius:50%;border:2px solid #8fd3ff;border-top-color:transparent;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* split helpers */
    .split #camControls{top:50%;left:12px;bottom:auto;transform:translateY(-50%);flex-direction:column;align-items:stretch}
    .split #globalControls{bottom:70px;left:50%;transform:translateX(-50%);top:auto}
    .split #syncStatus{bottom:122px;left:50%;transform:translateX(-50%);top:auto}

    /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    button{-webkit-tap-highlight-color:transparent;appearance:none;border:0;outline:0;cursor:pointer;background:var(--btn-bg);color:var(--btn-txt);
      padding:11px 12px;font-size:12px;line-height:1;font-weight:800;border-radius:12px;letter-spacing:.2px;min-width:auto;position:relative;
      box-shadow:0 8px 18px #000a,0 0 0 0 var(--btn-ring);transition:transform .12s,box-shadow .12s,background .12s,opacity .12s,filter .12s;
      opacity:.35;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    body.ui-awake button{opacity:1}
    button:hover{background:var(--btn-bg-h);box-shadow:0 12px 26px #000c,0 0 0 6px var(--btn-ring)}
    button:active{background:var(--btn-bg-a);transform:translateY(1px)}

    /* Ø§Ù„Ù„ÙˆØ¯Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø¶ØºÙˆØ· ÙÙ‚Ø· */
    .btn-loading{opacity:.9;pointer-events:none;filter:saturate(.95)}
    .btn-loading::after{content:"";position:absolute;inset:auto 6px 6px auto;width:14px;height:14px;border-radius:50%;
      border:2px solid #fff8;border-top-color:transparent;animation:spin .6s linear infinite}

    .icon{width:16px;height:16px;display:inline-block}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Ø²Ø± Ø§Ù„ØµÙˆØª */
    #btnSound{min-width:auto;padding:6px 8px}
    #btnSound svg{display:inline-block;vertical-align:middle}
    #btnSound[data-muted="true"]  .icon-sound-on{display:none}
    #btnSound[data-muted="true"]  .icon-sound-off{display:inline}
    #btnSound[data-muted="false"] .icon-sound-on{display:inline}
    #btnSound[data-muted="false"] .icon-sound-off{display:none}

    #gatePlay{position:absolute;inset:0;z-index:9;display:flex;align-items:center;justify-content:center;background:linear-gradient(140deg,rgba(0,0,0,.55),rgba(0,0,0,.2));backdrop-filter:blur(2px)}
    #gatePlay.hidden{display:none}
    .gate-card{background:var(--panel-bg);border:1px solid var(--panel-bd);border-radius:18px;padding:18px 20px;display:flex;gap:12px;align-items:center;box-shadow:0 10px 40px rgba(0,0,0,.45)}
    .gate-card .icon{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--panel-bd);color:#fff;background:#111a;font-size:18px}
    #startBtn{min-width:160px}
    #zoomBtn{min-width:auto;padding:10px 12px}
    .badge{font-size:10px;padding:3px 8px;border:1px solid var(--panel-bd);border-radius:999px;color:#cfe8ff;background:#0a2236aa}

    .swap-enter{opacity:0;transition:opacity .18s ease}
    .swap-enter.swap-enter-active{opacity:1}

    /* Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø£ÙÙ‚ÙŠ */
    @media (orientation: landscape) and (max-width: 900px){
      #mainPreview{width:32%;height:30%;right:18px;top:14px;border-width:1.5px;border-radius:18px;z-index:6}
      .hint{display:none}
      #camControls{top:50%;left:8px;bottom:auto;transform:translateY(-50%);flex-direction:column;align-items:stretch;padding:8px;gap:6px}
      #camControls button{min-width:86px;font-size:10px;padding:8px 10px;border-radius:10px}
      #globalControls{bottom:calc(env(safe-area-inset-bottom,0px)+14px);left:50%;transform:translateX(-50%);padding:8px 10px;min-width:260px}
      #scrub{width:220px}
      #syncStatus{bottom:calc(env(safe-area-inset-bottom,0px)+98px)}
      .split #globalControls{bottom:35px}
      .split #syncStatus{bottom:58px}
    }

    /* Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¹Ù…ÙˆØ¯ÙŠ */
    @media (orientation: portrait){
      #mainPreview{top:12px;right:14px;left:auto;transform:none;width:58vw;height:36vh;border-radius:18px}
      #globalControls{bottom:calc(env(safe-area-inset-bottom,0px)+12px);left:50%;transform:translateX(-50%);width:min(94vw,560px);min-width:unset;padding:8px 10px;z-index:20}
      #scrub{width:clamp(140px,56vw,380px)}
      #syncStatus{bottom:calc(env(safe-area-inset-bottom,0px)+58px)}

      /* Ø¯ÙˆÙƒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª */
      #camControls{
        top:60px;left:6px;right:auto;bottom:auto;transform:none;display:flex;flex-direction:column;align-items:stretch;gap:6px;
        padding:8px 6px;max-height:58vh;overflow:auto;-webkit-overflow-scrolling:touch;background:linear-gradient(180deg,#0b0b0fb3,#0b0b0f99);
        border:1px solid var(--panel-bd);border-radius:14px;width:46px;transition:width .18s ease,box-shadow .18s ease;box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:12
      }
      #camControls::-webkit-scrollbar{display:none}
      #camControls::before{content:"â‰¡";display:block;text-align:center;color:#ffd6d6;opacity:.95;font-weight:800;font-size:14px;margin-bottom:6px;padding:4px 0;border-radius:10px;border:1px solid var(--panel-bd);background:#3a0c0caa}
      #camControls:hover,#camControls.expanded{width:150px}
      #camControls button{display:flex;align-items:center;justify-content:flex-start;gap:8px;border-radius:12px;padding:8px 10px;min-width:auto;width:100%;font-size:11px;background:#1a1f2a;color:#fff;border:1px solid #ffffff1f;box-shadow:inset 0 0 0 1px #0003;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      #camControls button::before{content:"";width:8px;height:8px;border-radius:50%;margin-left:4px;background:radial-gradient(circle at 30% 30%,#ff6b6b,#e53935);box-shadow:0 0 10px rgba(229,57,53,.75)}
      #camControls:not(.expanded):not(:hover) button{padding:8px 6px}
      #camControls:not(.expanded):not(:hover) button span{display:none}
      #camControls button>span{display:inline}
    }

    /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ³Ø®ÙŠÙ† */
    #preloadBin{position:fixed;width:1px;height:1px;left:-9999px;top:-9999px;overflow:hidden;pointer-events:none;opacity:0}
  </style>
</head>
<body>
  <div id="playerContainer" aria-label="Ù…Ø´ØºÙ‘Ù„ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª">
    <div id="activeCam" class="videoFrame" aria-label="Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù†Ø´Ø·Ø©"></div>
    <div id="mainPreview" class="videoFrame" title="Ø§Ù†Ù‚Ø± Ù„Ù„ØªÙƒØ¨ÙŠØ±/Ø§Ù„ØªØµØºÙŠØ±" aria-label="Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ù…ØµØºÙ‘Ø±Ø©"></div>
    <div class="hint">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù„ØªÙƒØ¨ÙŠØ± â€¢ Ø£Ùˆ Ø§Ø¶ØºØ· F</div>

    <!-- gate -->
    <div id="gatePlay" role="dialog" aria-modal="true" aria-label="Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„">
      <div class="gate-card">
        <div class="icon">â–¶</div>
        <div>
          <div style="color:#fff;font-weight:800;margin-bottom:6px">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„</div>
          <div style="font-size:12px;color:#eaeaf0b3">Ø³ÙŠØ¨Ø¯Ø£ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© â€¢ Ø§Ù„ØµÙˆØª Ù…ÙƒØªÙˆÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§</div>
        </div>
        <button id="startBtn" aria-label="Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢Ù†">ØªØ´ØºÙŠÙ„/Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©<span class="sr-only">Space Ø£Ùˆ Enter</span></button>
      </div>
    </div>

    <!-- utility controls -->
    <div id="utilityControls" class="vertical">
      <div class="group">
        <!-- ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø´Ø§Ø´Ø© (Ø£ÙŠÙ‚ÙˆÙ†Ø© ØµØºÙŠØ±Ø©) -->
        <button id="btnSplit" aria-label="ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªÙ‚Ø³ÙŠÙ…" title="ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø´Ø§Ø´Ø©">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="16" rx="3"></rect>
            <line x1="12" y1="4" x2="12" y2="20"></line>
          </svg>
          <span class="sr-only">ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø´Ø§Ø´Ø© (S)</span>
        </button>
        <!-- Ù…Ù„Ø¡/Ø§Ø­ØªÙˆØ§Ø¡ -->
        <button id="btnFill" aria-label="ØªØ¨Ø¯ÙŠÙ„ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ" title="Ù…Ù„Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3,10 3,3 10,3"></polyline>
            <polyline points="21,14 21,21 14,21"></polyline>
            <line x1="3" y1="3" x2="10" y2="10"></line>
            <line x1="21" y1="21" x2="14" y2="14"></line>
          </svg>
          <span class="sr-only">Ù…Ù„Ø¡/Ø§Ø­ØªÙˆØ§Ø¡</span>
        </button>
      </div>
      <span class="divider"></span>
      <div class="group">
        <!-- Ø§Ù„ØµÙˆØª -->
        <button id="btnSound" aria-label="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª" data-muted="true" title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª">
          <svg class="icon-sound-on" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="green" stroke="green" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10v4h4l5 4V6L7 10H3z"></path><path d="M14.5 8.5a4.5 4.5 0 0 1 0 6.4" fill="none"></path><path d="M16.8 6a8 8 0 0 1 0 12" fill="none"></path></svg>
          <svg class="icon-sound-off" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="red" stroke="red" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10v4h4l5 4V6L7 10H3z"></path><path d="M16 8l4 4m0 0l-4 4"></path></svg>
          <span class="sr-only">M</span>
        </button>
        <button id="zoomBtn" title="ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©" aria-label="ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©">ğŸ”</button>
      </div>
    </div>

    <!-- Ø´Ø§Ø±Ø© Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª -->
    <div id="shortcutsBadge" class="badge">Ø§Ø®ØªØµØ§Ø±Ø§Øª: Space/EnterØŒ MØŒ SØŒ F</div>

    <!-- global scrubber -->
    <div id="globalControls" class="hidden" role="group" aria-label="ØªØ­ÙƒÙ… Ù…ÙˆØ­Ù‘Ø¯">
      <button id="gBack" title="ØªØ£Ø®ÙŠØ± 5 Ø«ÙˆØ§Ù†Ù" aria-label="ØªØ£Ø®ÙŠØ± 5 Ø«ÙˆØ§Ù†Ù">âª 5s</button>
      <button id="gPlay" title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù" aria-label="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù">â¯</button>
      <button id="gFwd"  title="ØªÙ‚Ø¯ÙŠÙ… 5 Ø«ÙˆØ§Ù†Ù" aria-label="ØªÙ‚Ø¯ÙŠÙ… 5 Ø«ÙˆØ§Ù†Ù">5s â©</button>
      <input id="scrub" type="range" min="0" max="0" value="0" step="0.01" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…">
      <div id="timeLabel">00:00 / 00:00</div>
    </div>

    <!-- sync badge -->
    <div id="syncStatus" class="hidden" aria-live="polite">
      <div class="dot"></div><div>Ø¬ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©â€¦</div>
    </div>

    <!-- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª -->
    <div id="camControls" role="toolbar" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª">
      <button data-cam="cam1"><span>Cam1</span></button>
      <button data-cam="cam2"><span>Cam2</span></button>
      <button data-cam="cam3"><span>Cam3</span></button>
      <button data-cam="cam4"><span>Cam4</span></button>
      <button data-cam="cam5"><span>Sineflex</span></button>
      <button data-cam="cam6"><span>Drone</span></button>
    </div>
  </div>

  <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ³Ø®ÙŠÙ† -->
  <div id="preloadBin" aria-hidden="true"></div>

  <!-- Ø§Ù„Ù…ØµØ§Ø¯Ø± -->
  <script>
    window.sources = {
      main:  `/hls/live/playlist.m3u8`,
      cam1:  `/hls/lastone/playlist.m3u8`,
      cam2:  `/hls/live2/playlist.m3u8`,
      cam3:  `/hls/live3/playlist.m3u8`,
      cam4:  `/hls/live4/playlist.m3u8`,
      cam5:  `/hls/live5/playlist.m3u8`,
      cam6:  `/hls/live6/playlist.m3u8`
    };
  </script>

  <!-- player logic -->
  <script>
    /* Ø¥Ø¹Ø¯Ø§Ø¯ HLS (Ø¨Ø¯ÙˆÙ† Ø®Ù„Ø· durationCount) */
    const HLS_CONFIG = {
      lowLatencyMode: true,
      liveSyncDuration: 3,
      liveMaxLatencyDuration: 12,
      maxLiveSyncPlaybackRate: 1.25,
      capLevelToPlayerSize: true,
      maxBufferLength: 9,
      backBufferLength: 18,
      maxFragLookUpTolerance: 0.3,
      maxBufferHole: 0.2,
      nudgeMaxRetry: 7,
      highBufferWatchdogPeriod: 2,
      startFragPrefetch: true,
      abrEwmaDefaultEstimate: 3000000,
      enableWorker: true,
      fragLoadingMaxRetry: 8, fragLoadingRetryDelay: 300,
      manifestLoadingMaxRetry: 8, manifestLoadingRetryDelay: 600,
      levelLoadingMaxRetry: 6, levelLoadingRetryDelay: 600,
      xhrSetup: (xhr)=>{ try{ xhr.withCredentials=false; }catch(e){} }
    };

    const isPortrait = ()=> window.matchMedia('(orientation: portrait)').matches;

    function codecPlayable(c){ try{ const v=document.createElement('video'); return !!v.canPlayType(`video/mp4; codecs="${c}"`);}catch(e){return false;} }
    const SUPPORTS = { avc: codecPlayable('avc1.42E01E')||codecPlayable('avc1.4d401f')||codecPlayable('avc1.640028'),
                       hevc: codecPlayable('hvc1.1.6.L93.B0')||codecPlayable('hev1.1.6.L93.B0') };

    function pickPlayableLevel(levels){
      let i=levels.findIndex(l=>/avc1/i.test(l?.codecs||l?.codecsVideo||'')); if(i>=0 && SUPPORTS.avc) return i;
      i=levels.findIndex(l=>/(hvc1|hev1)/i.test(l?.codecs||l?.codecsVideo||'')); if(i>=0 && SUPPORTS.hevc) return i;
      return levels.length?0:-1;
    }

    const SYNC={ main:{pdtOffset:null,lastPDT:null}, active:{pdtOffset:null,lastPDT:null} };
    function trackPDT(hls, video, role){
      if(!hls || !(video instanceof HTMLVideoElement)) return;
      hls.on(Hls.Events.FRAG_CHANGED,(_,data)=>{
        const pdtMs=data?.frag?.programDateTime; if(!pdtMs) return;
        const pdtSec=pdtMs/1000; SYNC[role].lastPDT=pdtSec;
        const ct=Number(video.currentTime||0); const off=pdtSec-ct;
        if(isFinite(off)) SYNC[role].pdtOffset=off;
      });
    }
    function pdtAlignedTarget(mainCt){
      const pdtMain=(SYNC.main.pdtOffset!=null&&isFinite(SYNC.main.pdtOffset))?(SYNC.main.pdtOffset+(mainCt||0)):null;
      if(pdtMain!=null && SYNC.active.pdtOffset!=null && isFinite(SYNC.active.pdtOffset)){ return pdtMain - SYNC.active.pdtOffset; }
      return mainCt;
    }

    const root=document.getElementById('playerContainer');
    const mainContainer=document.getElementById('mainPreview');
    const camContainer=document.getElementById('activeCam');
    const gatePlay=document.getElementById('gatePlay');
    const startBtn=document.getElementById('startBtn');
    const camControls=document.getElementById('camControls');
    const btnSplit=document.getElementById('btnSplit');
    const btnFill=document.getElementById('btnFill');
    const btnSound=document.getElementById('btnSound');
    const zoomBtn=document.getElementById('zoomBtn');
    const globalControls=document.getElementById('globalControls');
    const gPlay=document.getElementById('gPlay');
    const gBack=document.getElementById('gBack');
    const gFwd=document.getElementById('gFwd');
    const scrub=document.getElementById('scrub');
    const timeLabel=document.getElementById('timeLabel');
    const syncStatus=document.getElementById('syncStatus');
    const preloadBin=document.getElementById('preloadBin');
    const utilityControls=document.getElementById('utilityControls');

    let mainPlayer, activePlayer, currentCam="cam1";
    let splitMode=0, isMainFull=false, fillMode=false, started=false, driftTimer=null, inited=false;

    /* ØªØ³Ø®ÙŠÙ† Ø®ÙÙŠÙ: Ù†Ø­Ø§ÙØ¸ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø¬Ø§Ø±ÙÙŠÙ’Ù† */
    const CAM_LIST = Object.keys(sources).filter(k=>k!=='main');
    const Warm = new Map(); // cam -> {wrapper, entity}
    function warmOne(cam){
      if(Warm.has(cam)) return;
      const w=document.createElement('div'); w.style.position='absolute'; w.style.inset='0'; preloadBin.appendChild(w);
      const ent=createVideo(w, sources[cam], 'active', {prewarm:false}); // Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù€ canplay Ø¨Ø³Ø±Ø¹Ø©
      Warm.set(cam, {wrapper:w, entity:ent});
      if(ent instanceof HTMLVideoElement){
        ent.addEventListener('canplay',()=>{ /* Ø¬Ø§Ù‡Ø² */ },{once:true});
      }
    }
    function keepNeighbors(center){
      const idx = CAM_LIST.indexOf(center); if(idx<0) return;
      const left = CAM_LIST[(idx-1+CAM_LIST.length)%CAM_LIST.length];
      const right= CAM_LIST[(idx+1)%CAM_LIST.length];
      warmOne(left); warmOne(right);
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø²Ø§Ø¦Ø¯
      for(const [k,v] of [...Warm.entries()]){
        if(k!==left && k!==right) { try{ v.entity.__hls?.stopLoad(); destroyVideoNode(v.wrapper);}catch(e){} Warm.delete(k); }
      }
    }
    function takeWarm(cam){
      const rec=Warm.get(cam); if(!rec) return null;
      camContainer.appendChild(rec.wrapper);
      const v = rec.wrapper.querySelector('video'); if(v){ v.style.objectFit=((splitMode===2||fillMode)?'cover':'contain'); }
      Warm.delete(cam); return rec.entity || v;
    }

    function ytId(u){ const m1=u.match(/[?&]v=([^&]+)/); if(m1) return m1[1]; const m2=u.match(/youtu\.be\/([^?&\/]+)/); if(m2) return m2[1];
                      const m3=u.match(/youtube\.com\/live\/([^?&\/]+)/); if(m3) return m3[1]; const m4=u.match(/embed\/([^?&\/]+)/); if(m4) return m4[1];
                      return u.split('/').pop(); }
    function vimeoEmbed(u,p){ const m=u.match(/vimeo\.com\/(?:video\/)?(\d+)/); const id=m?m[1]:''; const q=new URLSearchParams(p||{}).toString();
                              return `https://player.vimeo.com/video/${id}?${q}`; }

    function destroyVideoNode(node){
      if(!node) return;
      try{
        const vid = node.tagName==='VIDEO'? node : node.querySelector?.('video');
        const hls = vid?.__hls;
        if(vid){ try{ vid.pause(); }catch(e){} if(hls){ try{ hls.stopLoad(); hls.destroy(); }catch(e){} } vid.removeAttribute('src'); try{ vid.load?.(); }catch(e){} }
      }catch(e){}
      try{ node.remove(); }catch(e){}
    }
    function clampToSeekable(video,t){
      if(!(video instanceof HTMLVideoElement)) return t;
      const r=video.seekable; if(!r||!r.length) return t;
      const start=r.start(r.length-1), end=r.end(r.length-1);
      if(!isFinite(start)||!isFinite(end)) return t;
      return Math.min(Math.max(t, start+0.05), end-0.05);
    }

    function createVideo(container, url, role, opts={}){
      const prewarm=!!opts.prewarm; // Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ù…Ø³Ø§Ø±ØŒ ÙÙ‚Ø· Ù„Ø§ Ù†Ø¨Ø¯Ù‘Ù„ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ canplay
      const wrapper=document.createElement('div'); wrapper.style.position='absolute'; wrapper.style.inset='0'; wrapper.className='swap-enter';
      container.appendChild(wrapper); requestAnimationFrame(()=>wrapper.classList.add('swap-enter-active'));

      if(/youtube\.com|youtu\.be/i.test(url)){
        const div=document.createElement('div'); div.style.width='100%'; div.style.height='100%'; wrapper.appendChild(div);
        const player=new YT.Player(div,{videoId:ytId(url),playerVars:{autoplay:0,controls:0,rel:0,playsinline:1,muted:1}}); return player;
      }
      if(/vimeo\.com/i.test(url)){
        const params={autoplay:0,muted:1,controls:0,playsinline:1,autopause:0};
        const iframe=document.createElement('iframe'); iframe.src=vimeoEmbed(url,params);
        iframe.setAttribute('allow','autoplay; fullscreen; picture-in-picture; encrypted-media'); iframe.allowFullscreen=true;
        iframe.style.width='100%'; iframe.style.height='100%'; iframe.style.border='0'; wrapper.appendChild(iframe);
        return new Vimeo.Player(iframe,{autopause:false});
      }

      const video=document.createElement('video');
      video.autoplay=false; video.playsInline=true; video.controls=false; video.muted=true;
      video.preload='auto'; video.crossOrigin='anonymous';
      video.style.width='100%'; video.style.height='100%';
      video.style.objectFit=((splitMode===2||fillMode)?'cover':'contain');
      wrapper.appendChild(video);

      const kickPlay=()=>{ video.play().catch(()=>{}); };

      if(/\.m3u8(\?|$)/i.test(url)){
        if(video.canPlayType('application/vnd.apple.mpegURL')){
          video.src=url; if(!prewarm) video.addEventListener('loadedmetadata', kickPlay,{once:true});
        }else if(window.Hls && Hls.isSupported()){
          const hls=new Hls({...HLS_CONFIG}); video.__hls=hls; hls.attachMedia(video); hls.loadSource(url);
          trackPDT(hls, video, role);
          hls.on(Hls.Events.MANIFEST_PARSED,(_,data)=>{ try{ const idx=pickPlayableLevel(data?.levels||[]); if(idx>=0){ hls.nextLevel=idx; hls.currentLevel=idx; } }catch(e){} });
          hls.on(Hls.Events.ERROR,(_,data)=>{ if(!data?.fatal) return; try{
            if(data.type===Hls.ErrorTypes.NETWORK_ERROR) hls.startLoad();
            else if(data.type===Hls.ErrorTypes.MEDIA_ERROR) hls.recoverMediaError();
            else { hls.destroy(); const _h=new Hls({...HLS_CONFIG}); video.__hls=_h; _h.attachMedia(video); _h.loadSource(url); trackPDT(_h, video, role); }
          }catch(e){} });
          bindAntiStall(video);
          if(!prewarm) video.addEventListener('loadedmetadata', kickPlay,{once:true});
        }else{
          video.src=url; if(!prewarm) video.addEventListener('loadedmetadata', kickPlay,{once:true});
        }
      }else if(/\.mpd(\?|$)/i.test(url) && window.dashjs){
        const p=dashjs.MediaPlayer().create(); p.initialize(video,url,false);
        if(!prewarm) video.addEventListener('loadedmetadata', kickPlay,{once:true});
      }else{
        video.src=url; if(!prewarm) video.addEventListener('loadedmetadata', kickPlay,{once:true});
      }

      if(!prewarm){ video.addEventListener('canplay', ()=>{ [...container.children].slice(0,-1).forEach(ch=>destroyVideoNode(ch)); }, {once:true}); }
      return video;
    }

    function applySplitClasses(){
      root.classList.toggle('split',splitMode!==0);
      root.classList.toggle('fill',(splitMode!==0&&(splitMode===2||fillMode)));
      [mainContainer,camContainer].forEach(ct=>{ const v=ct.querySelector('video'); if(v){ v.style.objectFit=((splitMode===2||fillMode)?'cover':'contain'); } });
      positionUtilityDock();
    }
    function toggleSplitMode(){ splitMode=(splitMode+1)%3; if(splitMode!==0 && isMainFull){ isMainFull=false; root.classList.remove('main-full'); } applySplitClasses(); }
    function toggleFillMode(){ fillMode=!fillMode; applySplitClasses(); }
    function toggleMainZoom(){ if(splitMode!==0) return; isMainFull=!isMainFull; root.classList.toggle('main-full',isMainFull); positionUtilityDock(); }

    function initPlayers(){ if(!mainPlayer){ mainPlayer=createVideo(mainContainer, sources.main, 'main'); } activePlayer=createVideo(camContainer, sources[currentCam], 'active'); }
    function initPlayersOnce(){ if(inited) return; inited=true; initPlayers(); }

    async function playEntity(ent, keepMuted=true){
      if(ent && ent.getVolume && ent.play){ try{ if(keepMuted) await ent.setVolume(0); await ent.play(); }catch(e){} return; }
      if(ent && ent.playVideo){ try{ ent.mute(); ent.playVideo(); }catch(e){} return; }
      if(ent instanceof HTMLVideoElement){ try{ ent.muted=!!keepMuted; await ent.play(); }catch(e){} }
    }

    async function startPlayback(){
      if(started) return; started=true; gatePlay.classList.add('hidden');
      await playEntity(mainPlayer,true);
      await playEntity(activePlayer,true);
      keepNeighbors(currentCam);

      globalControls.classList.remove('hidden'); await initDurations(); setTimeout(syncCams,220);
      startDriftCorrection(); startTimeTicker(); reflectSoundState();
      positionUtilityDock();
    }

    function getMainTime(){ if(mainPlayer && mainPlayer.getCurrentTime) return mainPlayer.getCurrentTime(); if(mainPlayer instanceof HTMLVideoElement) return Promise.resolve(mainPlayer.currentTime||0); return Promise.resolve(0); }
    function getMainDuration(){
      if(mainPlayer && mainPlayer.getDuration) return mainPlayer.getDuration();
      if(mainPlayer instanceof HTMLVideoElement){ const d=mainPlayer.duration; if(isFinite(d)) return Promise.resolve(d||0); const r=mainPlayer.seekable; if(r&&r.length){ return Promise.resolve(r.end(r.length-1)||0); } return Promise.resolve(0); }
      return Promise.resolve(0);
    }
    function seekMainTo(t){ if(mainPlayer && mainPlayer.setCurrentTime) return mainPlayer.setCurrentTime(t).catch(()=>{}); if(mainPlayer && mainPlayer.seekTo){ try{ mainPlayer.seekTo(t,true);}catch(e){} return Promise.resolve(); } if(mainPlayer instanceof HTMLVideoElement){ mainPlayer.currentTime=clampToSeekable(mainPlayer,t);} return Promise.resolve(); }
    function seekActiveTo(t){ if(activePlayer && activePlayer.setCurrentTime) return activePlayer.setCurrentTime(t).catch(()=>{}); if(activePlayer && activePlayer.seekTo){ try{ activePlayer.seekTo(t,true);}catch(e){} return Promise.resolve(); } if(activePlayer instanceof HTMLVideoElement){ activePlayer.currentTime=clampToSeekable(activePlayer,t);} return Promise.resolve(); }

    async function syncCams(showBadge=false){
      if(showBadge) syncStatus.classList.remove('hidden'); else syncStatus.classList.add('hidden');
      try{ const t=await getMainTime(); const target=pdtAlignedTarget(t); await seekActiveTo(target); }
      finally{ if(showBadge) setTimeout(()=>syncStatus.classList.add('hidden'),150); }
    }

    function startDriftCorrection(){
      stopDriftCorrection();
      driftTimer=setInterval(async()=>{
        try{
          const mt=await getMainTime();
          const atProm=(activePlayer && activePlayer.getCurrentTime)?activePlayer.getCurrentTime():Promise.resolve(activePlayer?.currentTime||0);
          const at=await atProm;
          const wMain=(SYNC.main.pdtOffset!=null)? SYNC.main.pdtOffset + (mt||0) : null;
          const wAct =(SYNC.active.pdtOffset!=null)? SYNC.active.pdtOffset + (at||0) : null;
          const drift=(wMain!=null && wAct!=null)? Math.abs(wAct - wMain) : Math.abs((at||0)-(mt||0));
          if(drift>0.25){ syncStatus.classList.remove('hidden'); const target=pdtAlignedTarget(mt); await seekActiveTo(target); setTimeout(()=>syncStatus.classList.add('hidden'),140); }
        }catch(e){}
      }, 2200);
    }
    function stopDriftCorrection(){ if(driftTimer){ clearInterval(driftTimer); driftTimer=null; } }

    async function initDurations(){ const d=await getMainDuration(); scrub.max=(d&&isFinite(d))?d:0; }
    function fmt(t){ t=Math.max(0,Math.floor(t||0)); const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(t%60).padStart(2,'0'); return `${m}:${s}`; }
    let ticker=null, isScrubbing=false;
    function startTimeTicker(){ if(ticker) return; ticker=setInterval(async()=>{ if(isScrubbing) return; const ct=await getMainTime(); let d=await getMainDuration(); if(mainPlayer instanceof HTMLVideoElement){ const r=mainPlayer.seekable; if(r&&r.length){ d=r.end(r.length-1)||d; } } if(d&&isFinite(d)) scrub.max=d; scrub.value=ct||0; timeLabel.textContent=`${fmt(ct)} / ${fmt(d||0)}`; },250); }

    async function reflectSoundState(){
      let muted=true;
      try{
        if(/vimeo\.com/i.test(sources.main) && mainPlayer && mainPlayer.getVolume){ const v=await mainPlayer.getVolume(); muted=(v===0); }
        else if(/youtube\.com|youtu\.be/i.test(sources.main) && mainPlayer && mainPlayer.isMuted){ muted=!!mainPlayer.isMuted(); }
        else if(mainPlayer instanceof HTMLVideoElement){ muted=!!mainPlayer.muted; }
      }catch(e){}
      btnSound.dataset.muted=String(muted);
      btnSound.setAttribute('aria-label', muted?'ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª':'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª');
      btnSound.title=muted?'ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª':'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª';
    }

    async function toggleSound(){
      if(!started){ await startPlayback(); }
      if(/vimeo\.com/i.test(sources.main) && mainPlayer && mainPlayer.getVolume){
        try{ const v=await mainPlayer.getVolume(); if(v>0){ await mainPlayer.setVolume(0); } else { await mainPlayer.setVolume(1); await mainPlayer.play().catch(()=>{}); } }catch(e){}
        await reflectSoundState(); return;
      }
      if(/youtube\.com|youtu\.be/i.test(sources.main) && mainPlayer && mainPlayer.isMuted){
        try{ if(mainPlayer.isMuted()) mainPlayer.unMute(); else mainPlayer.mute(); try{ mainPlayer.playVideo(); }catch(e){} }catch(e){}
        await reflectSoundState(); return;
      }
      if(mainPlayer instanceof HTMLVideoElement){
        try{ if(mainPlayer.muted){ mainPlayer.muted=false; mainPlayer.volume=1; await mainPlayer.play().catch(()=>{}); } else { mainPlayer.muted=true; } }catch(e){}
        await reflectSoundState();
      }
    }

    async function togglePlayPause(){
      if(/vimeo\.com/i.test(sources.main) && mainPlayer && mainPlayer.getPaused){
        const p=await mainPlayer.getPaused().catch(()=>null); if(p===null) return; if(p){ await mainPlayer.play().catch(()=>{}); } else { await mainPlayer.pause().catch(()=>{}); }
        const mt=await getMainTime(); const target=pdtAlignedTarget(mt); await seekActiveTo(target); return;
      }
      if(/youtube\.com|youtu\.be/i.test(sources.main) && mainPlayer && mainPlayer.getPlayerState){
        const st=mainPlayer.getPlayerState(); if(st===1){ try{mainPlayer.pauseVideo()}catch(e){} } else { try{mainPlayer.playVideo()}catch(e){} }
        const mt=await getMainTime(); const target=pdtAlignedTarget(mt); await seekActiveTo(target); return;
      }
      if(mainPlayer instanceof HTMLVideoElement){
        if(mainPlayer.paused){ await mainPlayer.play().catch(()=>{}); } else { mainPlayer.pause(); }
        const mt=await getMainTime(); const target=pdtAlignedTarget(mt); await seekActiveTo(target);
      }
    }

    async function jumpBy(dlt){
      const t=await getMainTime(); const d=await getMainDuration();
      let nt=(t||0)+dlt; if(d&&isFinite(d)) nt=Math.min(Math.max(0,nt),d);
      await seekMainTo(nt); const target=pdtAlignedTarget(nt); await seekActiveTo(target);
    }

    /* Anti-stall */
    function bindAntiStall(video){
      if(!(video instanceof HTMLVideoElement)) return;
      let lastTime = 0;
      const watchdog = ()=>{
        const ct = video.currentTime || 0;
        const progressed = Math.abs(ct - lastTime) > 0.02;
        lastTime = ct;
        if(!progressed || video.readyState < 3){
          try{
            const r = video.seekable;
            if(r && r.length){
              const end = r.end(r.length-1);
              const target = clampToSeekable(video, Math.min(end-0.05, ct+0.12));
              if(Math.abs(target - ct) > 0.01){ video.currentTime = target; }
            }
            video.__hls?.startLoad(0);
            video.play().catch(()=>{});
          }catch(e){}
        }
      };
      video.addEventListener('waiting', watchdog);
      video.addEventListener('stalled', watchdog);
      video.addEventListener('suspend', ()=>setTimeout(watchdog, 150));
      setInterval(watchdog, 700);
    }

    /* ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª â€” Ø§Ù„Ù„ÙˆØ¯Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± ÙÙ‚Ø· */
    function switchCam(cam, btn){
      currentCam=cam;
      if(btn){ btn.classList.add('btn-loading'); setTimeout(()=>btn.classList.remove('btn-loading'), 1600); }

      const warmed = takeWarm(cam);
      if(warmed){
        const promote = async()=>{
          const old = activePlayer; activePlayer = warmed;
          await playEntity(activePlayer,true);
          const mt=await getMainTime(); const target=pdtAlignedTarget(mt); await seekActiveTo(target);
          [...camContainer.children].slice(0,-1).forEach(ch=>destroyVideoNode(ch));
          if(activePlayer instanceof HTMLVideoElement) bindAntiStall(activePlayer);
          keepNeighbors(currentCam);
        };
        if(warmed instanceof HTMLVideoElement && warmed.readyState<2){ warmed.addEventListener('canplay',promote,{once:true}); playEntity(warmed,true); } else { promote(); }
        return;
      }

      const newcomer=createVideo(camContainer, sources[cam], 'active');
      const promote=async()=>{
        activePlayer=newcomer;
        await playEntity(activePlayer,true);
        const mt=await getMainTime(); const target=pdtAlignedTarget(mt); await seekActiveTo(target);
        [...camContainer.children].slice(0,-1).forEach(ch=>destroyVideoNode(ch));
        if(activePlayer instanceof HTMLVideoElement) bindAntiStall(activePlayer);
        keepNeighbors(currentCam);
      };
      if(newcomer instanceof HTMLVideoElement){ newcomer.addEventListener('canplay',promote,{once:true}); playEntity(newcomer,true); } else { promote(); }
    }

    /* ØªÙ…ÙˆØ¶Ø¹ utilityControls */
    function positionUtilityDock(){
      if(root.classList.contains('main-full')){ utilityControls.style.display='none'; return; }
      utilityControls.style.display='flex';
      const margin=10, mp=mainContainer.getBoundingClientRect();

      if(splitMode===0){
        utilityControls.classList.add('vertical'); utilityControls.classList.remove('horizontal');
        requestAnimationFrame(()=>{
          const cr=utilityControls.getBoundingClientRect();
          let left = mp.left - cr.width - margin; if(left<margin) left=margin;
          let top  = mp.top + (mp.height - cr.height)/2;
          top = Math.max(margin, Math.min(top, window.innerHeight - cr.height - margin));
          utilityControls.style.left = left+'px'; utilityControls.style.right='auto'; utilityControls.style.top = top+'px';
        });
      }else{
        utilityControls.classList.remove('vertical'); utilityControls.classList.add('horizontal');
        utilityControls.style.top = margin+'px'; utilityControls.style.right = margin+'px'; utilityControls.style.left='auto';
      }
    }
    window.addEventListener('resize', positionUtilityDock);
    window.addEventListener('orientationchange', ()=>setTimeout(positionUtilityDock,120));

    /* Ø§Ù„Ø£Ø­Ø¯Ø§Ø« */
    startBtn.addEventListener('click',async()=>{ await startPlayback(); positionUtilityDock(); });
    mainContainer.addEventListener('click',()=>{ toggleMainZoom(); positionUtilityDock(); });
    zoomBtn.addEventListener('click',()=>{ toggleMainZoom(); positionUtilityDock(); });
    btnSplit.addEventListener('click',()=>{ toggleSplitMode(); positionUtilityDock(); });
    btnFill.addEventListener('click',()=>{ toggleFillMode(); positionUtilityDock(); });
    btnSound.addEventListener('click',toggleSound);
    window.addEventListener('load', positionUtilityDock);

    document.addEventListener('keydown',(e)=>{
      if(e.key===' '||e.key==='Enter'){ e.preventDefault(); startPlayback(); }
      if(e.key==='S'||e.key==='s'){ toggleSplitMode(); positionUtilityDock(); }
      if(e.key==='F'||e.key==='f'){ toggleMainZoom(); positionUtilityDock(); }
      if(e.key==='M'||e.key==='m'){ toggleSound(); }
    });

    gPlay.addEventListener('click',togglePlayPause);
    gBack.addEventListener('click',()=>jumpBy(-5));
    gFwd.addEventListener('click',()=>jumpBy(+5));
    scrub.addEventListener('input',()=>{ isScrubbing=true; timeLabel.textContent=`${fmt(scrub.value)} / ${fmt(scrub.max||0)}`; });
    scrub.addEventListener('change',async()=>{ const nt=parseFloat(scrub.value)||0; await seekMainTo(nt); const target=pdtAlignedTarget(nt); await seekActiveTo(target); isScrubbing=false; });

    camControls.addEventListener('click',(e)=>{
      const btn=e.target.closest('button[data-cam]'); if(!btn) return;
      switchCam(btn.getAttribute('data-cam'), btn);
      if(isPortrait()) setTimeout(()=>camControls.classList.remove('expanded'),140);
    });

    (function cameraDockInteraction(){
      const dock=camControls; let touchStartY=0,moved=false;
      dock.addEventListener('touchstart',(e)=>{ if(!isPortrait()) return; touchStartY=e.touches[0].clientY;moved=false; },{passive:true});
      dock.addEventListener('touchmove',(e)=>{ if(!isPortrait()) return; if(Math.abs(e.touches[0].clientY-touchStartY)>6) moved=true; },{passive:true});
      dock.addEventListener('touchend',(e)=>{ if(!isPortrait()) return; if(e.target && e.target.closest('button')) return; if(!moved){ dock.classList.toggle('expanded'); } });
      dock.addEventListener('click',(e)=>{ if(!isPortrait()) return; if(e.target.closest('button')) return; dock.classList.toggle('expanded'); });
    })();

    document.addEventListener('click',(e)=>{ if(!isPortrait()) return; if(!camControls.contains(e.target)) camControls.classList.remove('expanded'); });

    /* Init */
    window.onYouTubeIframeAPIReady=()=>{ if(!inited) initPlayersOnce(); };
    window.addEventListener('DOMContentLoaded', ()=>{ initPlayersOnce(); });

    document.addEventListener('visibilitychange', ()=>{ try{ document.querySelectorAll('video').forEach(v=>{ if(v.paused) v.play().catch(()=>{}); }); }catch(e){} });

    (function autoUi(){
      let t=null; const wake=()=>{ document.body.classList.add('ui-awake'); clearTimeout(t); t=setTimeout(()=>document.body.classList.remove('ui-awake'),1800); };
      ['mousemove','touchstart','touchmove','keydown','click'].forEach(ev=>window.addEventListener(ev,wake,{passive:true})); wake();
    })();
  </script>
</body>
</html>
