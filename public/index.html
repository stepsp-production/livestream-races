<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Universal Multi-Cam Player â€” HLS Sync+ (Mobile Tuned)</title>

  <!-- Players -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://player.vimeo.com/api/player.js"></script>

  <!-- Fix favicon 404 -->
  <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230b0b0f'/%3E%3Cpolygon points='26,20 26,44 46,32' fill='%23e53935'/%3E%3C/svg%3E" />

  <style>
    :root{
      --btn-bg:#e53935; --btn-bg-h:#d32f2f; --btn-bg-a:#b71c1c; --btn-txt:#fff;
      --btn-ring:rgba(211,47,47,.28);
      --panel-bg:#0b0b0fbb; --panel-bd:#ffffff26;
      --accent:#40c4ff;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

    #playerContainer{position:relative;width:100vw;height:100vh}
    .videoFrame{position:absolute;top:0;right:0;width:100%;height:100%;background:#000;overflow:hidden}

    /* mini preview (audio source) */
    #mainPreview{
      position:absolute;top:18px;right:25px;width:20%;height:20%;
      z-index:5;border:1px solid #fff2;border-radius:12px;cursor:pointer;
      transition:transform .18s,box-shadow .18s,width .18s,height .18s,top .18s,right .18s,left .18s
    }
    #mainPreview:hover{box-shadow:0 10px 30px #0008}
    #mainPreview video{display:block;width:100%;height:100%;object-fit:contain}

    /* split */
    .split #mainPreview{top:0;right:0;left:auto;width:50%;height:100%;border-radius:0;border-width:0;cursor:default}
    .split #activeCam{top:0;left:0;right:auto;width:50%;height:100%}
    .split.fill #mainPreview video,.split.fill #activeCam video{object-fit:cover}
    .split.fill #mainPreview iframe,.split.fill #activeCam iframe{position:absolute;inset:0;margin:auto;width:120%;height:120%}

    .main-full #mainPreview{top:0;right:0;width:100%;height:100%;z-index:6;border:0;border-radius:0;cursor:zoom-out}
    .main-full #activeCam{display:none}

    .hint{position:absolute;top:20px;right:25px;z-index:7;background:#000a;color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #fff2}
    .split .hint,.main-full .hint{display:none}

    /* panels */
    #utilityControls,#camControls,#globalControls,#syncStatus{position:absolute;z-index:8;display:flex;gap:8px;flex-wrap:wrap;transition:opacity .18s,transform .18s}
    #utilityControls{
      top:12px;left:14px;background:var(--panel-bg);padding:10px;border-radius:14px;border:2px solid var(--panel-bd);
      backdrop-filter:blur(8px);align-items:center
    }
    #utilityControls .group{display:flex;gap:8px;align-items:center}
    .divider{width:1px;height:26px;background:var(--panel-bd);margin:0 6px;border-radius:2px}

    /* global scrubber (center bottom) */
    #globalControls{
      bottom:70px;left:50%;transform:translateX(-50%);
      background:var(--panel-bg);padding:10px;border-radius:14px;border:1px solid var(--panel-bd);
      backdrop-filter:blur(8px);align-items:center;min-width:320px
    }
    #globalControls.hidden{display:none}

    #scrub{-webkit-appearance:none;appearance:none;width:320px;height:6px;border-radius:999px;background:#ffffff30;outline:none;margin:0 8px}
    #scrub::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid #0006;cursor:pointer}
    #timeLabel{color:#fff;font-size:12px;min-width:108px;text-align:center}

    /* camera buttons (default desktop) */
    #camControls{
      bottom:14px;left:50%;transform:translateX(-50%);
      background:var(--panel-bg);padding:10px;border-radius:14px;border:1px solid var(--panel-bd);backdrop-filter:blur(8px)
    }

    #syncStatus{
      bottom:122px;left:50%;transform:translateX(-50%);
      background:#08131fbb;color:#e6f3ff;border:1px solid var(--panel-bd);
      padding:6px 10px;border-radius:10px;font-size:12px;align-items:center;gap:6px
    }
    #syncStatus.hidden{display:none}
    .dot{width:10px;height:10px;border-radius:50%;border:2px solid #8fd3ff;border-top-color:transparent;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* split layout */
    .split #camControls{top:50%;left:12px;bottom:auto;transform:translateY(-50%);flex-direction:column;align-items:stretch}
    .split #globalControls{bottom:70px;left:50%;transform:translateX(-50%);top:auto}
    .split #syncStatus{bottom:122px;left:50%;transform:translateX(-50%);top:auto}

    /* buttons look */
    button{
      -webkit-tap-highlight-color:transparent;appearance:none;border:0;outline:0;cursor:pointer;
      background:var(--btn-bg);color:var(--btn-txt);padding:11px 14px;font-size:11px;line-height:1;font-weight:800;
      border-radius:12px;letter-spacing:.2px;min-width:92px;position:relative;
      box-shadow:0 8px 18px #000a,0 0 0 0 var(--btn-ring);
      transition:transform .12s,box-shadow .12s,background .12s,opacity .12s,filter .12s;
      opacity:.35;
    }
    body.ui-awake button{opacity:1}
    button:hover{background:var(--btn-bg-h);box-shadow:0 12px 26px #000c,0 0 0 6px var(--btn-ring)}
    button:active{background:var(--btn-bg-a);transform:translateY(1px)}
    button .sub{display:block;font-weight:600;font-size:10px;opacity:.85;margin-top:4px}
    .loading{opacity:.85;pointer-events:none;filter:saturate(.85)}
    .loading::after{content:"";position:absolute;inset:auto 8px 8px auto;width:16px;height:16px;border-radius:50%;border:2px solid #fff8;border-top-color:transparent;animation:spin .8s linear infinite}

    /* ğŸ”Š Ø²Ø± Ø§Ù„ØµÙˆØª Ø£ÙŠÙ‚ÙˆÙ†Ø© ØµØºÙŠØ±Ø© */
    #btnSound{
      min-width:auto; padding:6px 8px; display:inline-flex; align-items:center; justify-content:center; gap:6px;
    }
    #btnSound svg{display:inline-block; vertical-align:middle}
    #btnSound[data-muted="true"]  .icon-sound-on{display:none}
    #btnSound[data-muted="true"]  .icon-sound-off{display:inline}
    #btnSound[data-muted="false"] .icon-sound-on{display:inline}
    #btnSound[data-muted="false"] .icon-sound-off{display:none}

    #gatePlay{position:absolute;inset:0;z-index:7;display:flex;align-items:center;justify-content:center;background:linear-gradient(140deg,rgba(0,0,0,.55),rgba(0,0,0,.2));backdrop-filter:blur(2px)}
    #gatePlay.hidden{display:none}
    .gate-card{background:var(--panel-bg);border:1px solid var(--panel-bd);border-radius:18px;padding:18px 20px;display:flex;gap:12px;align-items:center;box-shadow:0 10px 40px rgba(0,0,0,.45)}
    .icon{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--panel-bd);color:#fff;background:#111a;font-size:18px}
    #startBtn{min-width:160px}
    #zoomBtn{min-width:auto;padding:10px 12px}
    .badge{font-size:10px;padding:3px 8px;border:1px solid var(--panel-bd);border-radius:999px;color:#cfe8ff;background:#0a2236aa}

    .swap-enter{opacity:0;transition:opacity .18s ease}
    .swap-enter.swap-enter-active{opacity:1}

    /* ===== Mobile (landscape) ===== */
    @media (orientation: landscape) and (max-width: 900px){
      #mainPreview{width:30%;height:20%;left:25px; top:18px;border-width:1.5px;border-radius:10px; z-index:6}
      .hint{display:none}

      /* Ø§Ø±ÙØ¹ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø±Ø§ÙÙ‚ ÙÙˆÙ‚ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
      #utilityControls{
        top:auto;
        bottom: calc(env(safe-area-inset-bottom, 0px) + 110px);
        left:10px; right:auto;
        padding:6px; gap:4px;
      }
      /* Ø¹Ù†Ø¯ Ø§Ù„ØªÙ‚Ø³ÙŠÙ… Ù†Ø±Ø¬Ù‘Ø¹Ù‡Ø§ Ø£Ø¹Ù„Ù‰-ÙŠØ³Ø§Ø± ÙƒÙ…Ø§ Ø§Ù„Ø£ØµÙ„ÙŠ */
      .split #utilityControls{
        top:18px; bottom:auto; left:10px; padding:4px;
      }

      #utilityControls .group{gap:4px}
      #btnSplit, #btnFill, #btnSound{padding:4px 4px; min-width:8px; font-size:8px; border-radius:10px}
      #zoomBtn{padding:4px 4px; min-width:auto}

      /* Ø¯ÙˆÙƒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª ÙÙŠ ÙŠØ³Ø§Ø± Ø§Ù„ÙˆØ³Ø· */
      #camControls{
        top:50%; left:8px; bottom:auto; transform:translateY(-50%);
        flex-direction:column; align-items:stretch; padding:8px; gap:6px;
      }
      #camControls button{min-width:86px; font-size:9px; padding:8px 10px; border-radius:10px}

      /* Ø§Ù„Ø´Ø±ÙŠØ· ÙŠØ¨Ù‚Ù‰ Ø£Ø³ÙÙ„ */
      #globalControls{
        bottom: calc(env(safe-area-inset-bottom, 0px) + 14px);
        left:50%; transform:translateX(-50%);
        padding:8px 10px; min-width:260px
      }
      #scrub{width:220px}
      #syncStatus{bottom: calc(env(safe-area-inset-bottom, 0px) + 98px)}
      .split #globalControls{bottom:35px}
      .split #syncStatus{bottom:58px}
    }

    /* ===== Ø§Ù„Ù‡Ø§ØªÙ: Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ ===== */
    @media (orientation: portrait) {
      /* ÙˆØ§Ø¬Ù‡Ø© main Ù…ÙØ­Ø³Ù‘Ù†Ø©: Ø£Ø¹Ù„Ù‰-Ù…Ù†ØªØµÙ ÙˆØ¨Ø­Ø¬Ù… Ù…ØªÙˆØ§Ø²Ù† */
      #mainPreview{
        top:12px; left:50%; right:auto; transform:translateX(-50%);
        width:58vw; height:32vh; border-radius:12px;
      }

      /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø±Ø§ÙÙ‚ Ø£Ø¹Ù„Ù‰-ÙŠØ³Ø§Ø± Ù…Ø¯Ù…Ø¬Ø© */
      #utilityControls{
        top:12px; left:10px; right:auto; bottom:auto;
        padding:6px; gap:6px;
      }

      /* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­ÙƒÙ‘Ù… Ø£Ø³ÙÙ„ Ù…Ø±ÙƒØ²ÙŠ Ù…Ø¹ Ù…Ø³Ø§Ø­Ø© Ø¢Ù…Ù†Ø© */
      #globalControls{
        bottom: calc(env(safe-area-inset-bottom, 0px) + 12px);
        left:50%; transform:translateX(-50%);
        width: min(94vw, 560px); min-width:unset; padding:8px 10px;
        z-index: 9;
      }
      #scrub{ width: clamp(140px, 56vw, 380px); }

      /* Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆÙ‚ Ø§Ù„Ø´Ø±ÙŠØ· Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
      #syncStatus{ bottom: calc(env(safe-area-inset-bottom, 0px) + 58px); }

      /* â­ Ø¯ÙˆÙƒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª â€œÙÙ„Ø§Ø´â€: Ø´Ø±ÙŠØ· Ø±Ø£Ø³ÙŠ Ù†Ø­ÙŠÙ ÙŠØªÙ…Ø¯Ø¯ Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ */
      #camControls{
        top: 60px; left: 6px; right: auto; bottom: auto; transform:none;
        display:flex; flex-direction:column; align-items:stretch; gap:6px;
        padding: 8px 6px;
        max-height: 58vh; overflow:auto; -webkit-overflow-scrolling: touch;
        background: linear-gradient(180deg, #0b0b0fb3, #0b0b0f99);
        border: 1px solid var(--panel-bd); border-radius: 14px;
        width: 46px; /* ÙˆØ¶Ø¹ Ù…Ø¶ØºÙˆØ· */
        transition: width .18s ease, box-shadow .18s ease;
        box-shadow: 0 8px 24px rgba(0,0,0,.35);
        z-index: 8;
      }
      #camControls::-webkit-scrollbar{display:none}

      #camControls::before{
        content: "â‰¡";
        display:block; text-align:center;
        color:#cfe8ff; opacity:.9; font-weight:800; font-size:14px;
        margin-bottom:6px; padding:4px 0;
        border-radius:10px; border:1px solid var(--panel-bd);
        background:#0a2236aa;
      }

      #camControls:hover,
      #camControls.expanded{ width: 150px; }

      #camControls button{
        display:flex; align-items:center; justify-content:flex-start;
        gap:8px; border-radius:12px; padding:8px 10px;
        min-width:auto; width: 100%; font-size:11px;
        background: #1a1f2a; color:#fff; border:1px solid #ffffff1f;
        box-shadow: inset 0 0 0 1px #0003;
        white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      }
      #camControls button::before{
        content:""; width:8px; height:8px; border-radius:50%; margin-left:4px;
        background: radial-gradient(circle at 30% 30%, #6cf, #39f);
        box-shadow: 0 0 10px #3af;
      }
      #camControls:not(.expanded):not(:hover) button{ padding:8px 6px; }
      #camControls:not(.expanded):not(:hover) button span{ display:none; }
      #camControls button > span{ display:inline; }
    }
  </style>
</head>
<body>
  <div id="playerContainer" aria-label="Ù…Ø´ØºÙ‘Ù„ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª">
    <div id="activeCam" class="videoFrame" aria-label="Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù†Ø´Ø·Ø©"></div>
    <div id="mainPreview" class="videoFrame" title="Ø§Ù†Ù‚Ø± Ù„Ù„ØªÙƒØ¨ÙŠØ±/Ø§Ù„ØªØµØºÙŠØ±" aria-label="Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ù…ØµØºÙ‘Ø±Ø©"></div>
    <div class="hint">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù„ØªÙƒØ¨ÙŠØ± â€¢ Ø£Ùˆ Ø§Ø¶ØºØ· F</div>

    <!-- gate -->
    <div id="gatePlay" role="dialog" aria-modal="true" aria-label="Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„">
      <div class="gate-card">
        <div class="icon">â–¶</div>
        <div>
          <div style="color:#fff;font-weight:800;margin-bottom:6px">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„</div>
          <div style="font-size:12px;color:#eaeaf0b3">Ø³ÙŠØ¨Ø¯Ø£ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© â€¢ Ø§Ù„ØµÙˆØª Ù…ÙƒØªÙˆÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§</div>
        </div>
        <button id="startBtn" aria-label="Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢Ù†">ØªØ´ØºÙŠÙ„/Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©<span class="sub">Space Ø£Ùˆ Enter</span></button>
      </div>
    </div>

    <!-- tools -->
    <div id="utilityControls">
      <div class="group">
        <button id="btnSplit" aria-label="ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªÙ‚Ø³ÙŠÙ…">ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø´Ø§Ø´Ø©<span class="sub">S</span></button>
        <button id="btnFill" aria-label="ØªØ¨Ø¯ÙŠÙ„ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ">Ù…Ù„Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</button>
      </div>
      <span class="divider"></span>
      <div class="group">
        <!-- ğŸ”Š Ø²Ø± Ø§Ù„ØµÙˆØª Ø¨Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª SVG ÙÙ‚Ø· -->
        <button id="btnSound" aria-label="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª" data-muted="true" title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª">
          <!-- ØªØ´ØºÙŠÙ„ (Ø£Ø®Ø¶Ø±) -->
          <svg class="icon-sound-on" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
               viewBox="0 0 24 24" fill="green" stroke="green" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
            <path d="M3 10v4h4l5 4V6L7 10H3z"></path>
            <path d="M14.5 8.5a4.5 4.5 0 0 1 0 6.4" fill="none"></path>
            <path d="M16.8 6a8 8 0 0 1 0 12" fill="none"></path>
          </svg>
          <!-- Ø¥ÙŠÙ‚Ø§Ù/ÙƒØªÙ… (Ø£Ø­Ù…Ø±) -->
          <svg class="icon-sound-off" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
               viewBox="0 0 24 24" fill="red" stroke="red" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
            <path d="M3 10v4h4l5 4V6L7 10H3z"></path>
            <path d="M16 8l4 4m0 0l-4 4"></path>
          </svg>
          <span class="sub">M</span>
        </button>

        <button id="zoomBtn" title="ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©" aria-label="ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©">ğŸ”</button>
      </div>
      <span class="divider"></span>
      <span class="badge">Ø§Ø®ØªØµØ§Ø±Ø§Øª: Space/EnterØŒ MØŒ SØŒ F</span>
    </div>

    <!-- global scrubber -->
    <div id="globalControls" class="hidden" role="group" aria-label="ØªØ­ÙƒÙ… Ù…ÙˆØ­Ù‘Ø¯">
      <button id="gBack" title="ØªØ£Ø®ÙŠØ± 5 Ø«ÙˆØ§Ù†Ù" aria-label="ØªØ£Ø®ÙŠØ± 5 Ø«ÙˆØ§Ù†Ù">âª 5s</button>
      <button id="gPlay" title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù" aria-label="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù">â¯</button>
      <button id="gFwd"  title="ØªÙ‚Ø¯ÙŠÙ… 5 Ø«ÙˆØ§Ù†Ù" aria-label="ØªÙ‚Ø¯ÙŠÙ… 5 Ø«ÙˆØ§Ù†Ù">5s â©</button>
      <input id="scrub" type="range" min="0" max="0" value="0" step="0.01" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…">
      <div id="timeLabel">00:00 / 00:00</div>
    </div>

    <!-- sync badge -->
    <div id="syncStatus" class="hidden" aria-live="polite">
      <div class="dot"></div><div>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©â€¦</div>
    </div>

    <!-- cameras (Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¯Ø§Ø®Ù„ span Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªÙˆØ³Ø¹Ø©) -->
    <div id="camControls" role="toolbar" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª">
      <button data-cam="cam1"><span>Cam1</span></button>
      <button data-cam="cam2"><span>Cam2</span></button>
      <button data-cam="cam3"><span>Cam3</span></button>
      <button data-cam="cam4"><span>Cam4</span></button>
      <button data-cam="cam5"><span>Sineflex</span></button>
      <button data-cam="cam6"><span>Drone</span></button>
    </div>
  </div>

  <!-- sources through Render proxy -->
  <script>
    window.sources = {
      main:  `/hls/live/playlist.m3u8`,
      cam1:  `/hls/lastone/playlist.m3u8`,
      cam2:  `/hls/live2/playlist.m3u8`,
      cam3:  `/hls/live3/playlist.m3u8`,
      cam4:  `/hls/live4/playlist.m3u8`,
      cam5:  `/hls/live5/playlist.m3u8`,
      cam6:  `/hls/live6/playlist.m3u8`
    };
  </script>

  <!-- player logic -->
  <script>
    // ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª HLS Ù„Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± =====
    const HLS_CONFIG = {
      lowLatencyMode: true,
      liveSyncDuration: 2,
      liveMaxLatencyDuration: 10,
      maxLiveSyncPlaybackRate: 1.2,
      capLevelToPlayerSize: true,
      maxBufferLength: 12,
      backBufferLength: 30,
      maxFragLookUpTolerance: 0.5,
      enableWorker: true,
      fragLoadingMaxRetry: 10,
      fragLoadingRetryDelay: 500,
      manifestLoadingMaxRetry: 10,
      manifestLoadingRetryDelay: 1000,
      levelLoadingMaxRetry: 10,
      levelLoadingRetryDelay: 1000,
      xhrSetup: (xhr) => { try { xhr.withCredentials = false; } catch(e){} }
    };

    // ===== ÙØ­Øµ Ø¯Ø¹Ù… Ø§Ù„ÙƒÙˆØ¯ÙƒØ§Øª =====
    function codecPlayable(codec){
      try{
        const v=document.createElement('video');
        return !!v.canPlayType(`video/mp4; codecs="${codec}"`);
      }catch(e){ return false; }
    }
    const SUPPORTS = {
      avc: codecPlayable('avc1.42E01E') || codecPlayable('avc1.4d401f') || codecPlayable('avc1.640028'),
      hevc: codecPlayable('hvc1.1.6.L93.B0') || codecPlayable('hev1.1.6.L93.B0')
    };
    function pickPlayableLevel(levels){
      let i = levels.findIndex(l=>/avc1/i.test(l?.codecs || l?.codecsVideo || ''));
      if(i>=0 && SUPPORTS.avc) return i;
      i = levels.findIndex(l=>/(hvc1|hev1)/i.test(l?.codecs || l?.codecsVideo || ''));
      if(i>=0 && SUPPORTS.hevc) return i;
      return levels.length?0:-1;
    }

    // ===== Ù…Ø­Ø§Ø°Ø§Ø© Ø¹Ø¨Ø± EXT-X-PROGRAM-DATE-TIME =====
    const SYNC = {
      main:   { pdtOffset: null, lastPDT: null },
      active: { pdtOffset: null, lastPDT: null }
    };
    function trackPDT(hls, video, role){
      if(!hls || !(video instanceof HTMLVideoElement)) return;
      hls.on(Hls.Events.FRAG_CHANGED, (_,data)=>{
        const pdtMs = data?.frag?.programDateTime;
        if(!pdtMs) return;
        const pdtSec = pdtMs/1000;
        SYNC[role].lastPDT = pdtSec;
        const ct = Number(video.currentTime||0);
        const off = pdtSec - ct;
        if (isFinite(off)) SYNC[role].pdtOffset = off;
      });
    }
    function pdtAlignedTarget(mainCt){
      const pdtMain = (SYNC.main.pdtOffset!=null && isFinite(SYNC.main.pdtOffset))
        ? (SYNC.main.pdtOffset + (mainCt||0)) : null;
      if(pdtMain!=null && SYNC.active.pdtOffset!=null && isFinite(SYNC.active.pdtOffset)){
        return pdtMain - SYNC.active.pdtOffset;
      }
      return mainCt;
    }

    function destroyVideoNode(node){
      if(!node) return;
      try{
        const vid = node.tagName === 'VIDEO' ? node : node.querySelector?.('video');
        const hls = vid?.__hls;
        if(vid){
          try { vid.pause(); } catch(e){}
          if(hls){ try{ hls.destroy(); }catch(e){} }
          vid.removeAttribute('src');
          try { vid.load?.(); } catch(e){}
        }
      }catch(e){}
      try { node.remove(); } catch(e){}
    }
    function clampToSeekable(video, t){
      if(!(video instanceof HTMLVideoElement)) return t;
      const r = video.seekable;
      if(!r || !r.length) return t;
      const start = r.start(r.length-1);
      const end   = r.end(r.length-1);
      if(!isFinite(start) || !isFinite(end)) return t;
      return Math.min(Math.max(t, start + 0.05), end - 0.05);
    }

    // ===== Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© =====
    let mainPlayer, activePlayer;
    let currentCam = "cam1";
    let splitMode = 0, isMainFull = false, fillMode = false, started = false, driftTimer = null;
    let inited = false;

    const root = document.getElementById('playerContainer');
    const mainContainer = document.getElementById('mainPreview');
    const camContainer  = document.getElementById('activeCam');
    const gatePlay = document.getElementById('gatePlay');
    const startBtn = document.getElementById('startBtn');
    const camControls = document.getElementById('camControls');
    const btnSplit = document.getElementById('btnSplit');
    const btnFill  = document.getElementById('btnFill');
    const btnSound = document.getElementById('btnSound');
    const zoomBtn  = document.getElementById('zoomBtn');
    const globalControls = document.getElementById('globalControls');
    const gPlay = document.getElementById('gPlay');
    const gBack = document.getElementById('gBack');
    const gFwd  = document.getElementById('gFwd');
    const scrub = document.getElementById('scrub');
    const timeLabel = document.getElementById('timeLabel');
    const syncStatus = document.getElementById('syncStatus');

    function ytId(u){
      const m1=u.match(/[?&]v=([^&]+)/); if(m1) return m1[1];
      const m2=u.match(/youtu\.be\/([^?&\/]+)/); if(m2) return m2[1];
      const m3=u.match(/youtube\.com\/live\/([^?&\/]+)/); if(m3) return m3[1];
      const m4=u.match(/embed\/([^?&\/]+)/); if(m4) return m4[1];
      return u.split('/').pop();
    }
    function vimeoEmbed(u,p){
      const m=u.match(/vimeo\.com\/(?:video\/)?(\d+)/); const id=m?m[1]:'';
      const q=new URLSearchParams(p||{}).toString();
      return `https://player.vimeo.com/video/${id}?${q}`;
    }

    function createVideo(container, url, role){
      const wrapper = document.createElement('div');
      wrapper.style.position='absolute';
      wrapper.style.inset='0';
      wrapper.className='swap-enter';
      container.appendChild(wrapper);
      requestAnimationFrame(()=>wrapper.classList.add('swap-enter-active'));

      // YouTube
      if(/youtube\.com|youtu\.be/i.test(url)){
        const id = ytId(url);
        const div=document.createElement('div');
        div.style.width='100%'; div.style.height='100%'; wrapper.appendChild(div);
        const player = new YT.Player(div,{videoId:id,playerVars:{autoplay:0,controls:0,rel:0,playsinline:1,muted:1}});
        return player;
      }
      // Vimeo
      if(/vimeo\.com/i.test(url)){
        const params={autoplay:0,muted:1,controls:0,playsinline:1,autopause:0};
        const iframe=document.createElement('iframe'); iframe.src=vimeoEmbed(url,params);
        iframe.setAttribute('allow','autoplay; fullscreen; picture-in-picture; encrypted-media'); iframe.allowFullscreen=true;
        iframe.style.width='100%'; iframe.style.height='100%'; iframe.style.border='0'; wrapper.appendChild(iframe);
        return new Vimeo.Player(iframe,{autopause:false});
      }

      // HTMLVideo (HLS/DASH/file)
      const video=document.createElement('video');
      video.autoplay=false; video.playsInline=true; video.controls=false; video.muted=true;
      video.preload='auto'; video.crossOrigin='anonymous';
      video.style.width='100%'; video.style.height='100%';
      video.style.objectFit=((splitMode===2||fillMode)?'cover':'contain');
      wrapper.appendChild(video);

      const kickPlay = () => { video.play().catch(()=>{}); };

      if(/\.m3u8(\?|$)/i.test(url)){
        if(video.canPlayType('application/vnd.apple.mpegURL')){
          video.src=url;
          video.addEventListener('loadedmetadata', kickPlay, {once:true});
        } else if(window.Hls && Hls.isSupported()){
          const hls=new Hls(HLS_CONFIG);
          video.__hls = hls;
          hls.attachMedia(video);
          hls.loadSource(url);

          // ØªØªØ¨Ø¹ PDT Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©
          trackPDT(hls, video, role);

          // Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙˆÙ‰ ÙÙŠØ¯ÙŠÙˆ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ´ØºÙŠÙ„
          hls.on(Hls.Events.MANIFEST_PARSED, (_, data) => {
            try {
              const levels = data?.levels || [];
              const idx = pickPlayableLevel(levels);
              if (idx >= 0) {
                hls.nextLevel = idx;
                hls.currentLevel = idx;
              } else {
                console.warn(`${role} stream has no browser-playable video level.`);
              }
            } catch(e){}
          });

          // Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³Ø§Ø± ØµÙˆØª (AAC Ø¥Ù† ÙˆÙØ¬Ø¯)
          hls.on(Hls.Events.AUDIO_TRACKS_UPDATED, (_, data) => {
            try{
              const tracks = data?.audioTracks || hls.audioTracks || [];
              let pick = tracks.find(t => /mp4a|aac/i.test(
                `${t?.codec||''} ${t?.name||''} ${t?.lang||''} ${t?.attrs?.CODECS||''}`
              ));
              if(!pick && tracks.length) pick = tracks[0];
              if(pick){
                hls.audioTrack = pick.id ?? tracks.indexOf(pick);
              }
            }catch(e){}
          });
          hls.on(Hls.Events.AUDIO_TRACK_SWITCHED, () => {
            if(role==='main' && !video.muted){ kickPlay(); }
          });

          // Ù…Ø±ÙˆÙ†Ø© Ø£Ø®Ø·Ø§Ø¡
          hls.on(Hls.Events.ERROR, (_, data)=>{
            if(!data?.fatal) return;
            switch(data.type){
              case Hls.ErrorTypes.NETWORK_ERROR:
                try{ hls.startLoad(); }catch(e){}
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                try{ hls.recoverMediaError(); }catch(e){}
                break;
              default:
                try{
                  hls.destroy();
                  const _h=new Hls(HLS_CONFIG);
                  video.__hls=_h;
                  _h.attachMedia(video);
                  _h.loadSource(url);
                  trackPDT(_h, video, role);
                }catch(e){}
            }
          });

          video.addEventListener('loadedmetadata', kickPlay, {once:true});
        } else {
          video.src=url;
          video.addEventListener('loadedmetadata', kickPlay, {once:true});
        }
      } else if(/\.mpd(\?|$)/i.test(url) && window.dashjs){
        const p = dashjs.MediaPlayer().create();
        p.initialize(video,url,false);
        video.addEventListener('loadedmetadata', kickPlay, {once:true});
      } else {
        video.src=url;
        video.addEventListener('loadedmetadata', kickPlay, {once:true});
      }

      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø£Ù‚Ø¯Ù…
      video.addEventListener('canplay', ()=>{
        [...container.children].slice(0,-1).forEach(ch=>destroyVideoNode(ch));
      },{once:true});

      return video;
    }

    function initPlayers(){
      if(!mainPlayer){ mainPlayer=createVideo(mainContainer, sources.main, 'main'); }
      activePlayer=createVideo(camContainer, sources[currentCam], 'active');
    }
    function initPlayersOnce(){ if(inited) return; inited=true; initPlayers(); }

    async function startPlayback(){
      if(started) return; started=true; gatePlay.classList.add('hidden');
      await playEntity(mainPlayer,true); await playEntity(activePlayer,true);
      globalControls.classList.remove('hidden'); await initDurations(); setTimeout(syncCams,400);
      startDriftCorrection(); startTimeTicker();
      reflectSoundState();
    }
    async function playEntity(ent, keepMuted=true){
      if(ent && ent.getVolume && ent.play){ try{ if(keepMuted) await ent.setVolume(0); await ent.play(); }catch(e){} return; }
      if(ent && ent.playVideo){ try{ ent.mute(); ent.playVideo(); }catch(e){} return; }
      if(ent instanceof HTMLVideoElement){ try{ ent.muted=!!keepMuted; await ent.play(); }catch(e){} }
    }

    function getMainTime(){
      if(mainPlayer && mainPlayer.getCurrentTime) return mainPlayer.getCurrentTime();
      if(mainPlayer instanceof HTMLVideoElement) return Promise.resolve(mainPlayer.currentTime||0);
      return Promise.resolve(0);
    }
    function getMainDuration(){
      if(mainPlayer && mainPlayer.getDuration) return mainPlayer.getDuration();
      if(mainPlayer instanceof HTMLVideoElement){
        const d = mainPlayer.duration;
        if(isFinite(d)) return Promise.resolve(d||0);
        const r=mainPlayer.seekable; if(r && r.length){ return Promise.resolve(r.end(r.length-1)||0); }
        return Promise.resolve(0);
      }
      return Promise.resolve(0);
    }
    function seekMainTo(t){
      if(mainPlayer && mainPlayer.setCurrentTime) return mainPlayer.setCurrentTime(t).catch(()=>{});
      if(mainPlayer && mainPlayer.seekTo){ try{ mainPlayer.seekTo(t,true); }catch(e){} return Promise.resolve(); }
      if(mainPlayer instanceof HTMLVideoElement){ mainPlayer.currentTime = clampToSeekable(mainPlayer,t); }
      return Promise.resolve();
    }
    function seekActiveTo(t){
      if(activePlayer && activePlayer.setCurrentTime) return activePlayer.setCurrentTime(t).catch(()=>{});
      if(activePlayer && activePlayer.seekTo){ try{ activePlayer.seekTo(t,true); }catch(e){} return Promise.resolve(); }
      if(activePlayer instanceof HTMLVideoElement){ activePlayer.currentTime = clampToSeekable(activePlayer,t); }
      return Promise.resolve();
    }

    async function syncCams(showBadge=true){
      if(showBadge) showSync(true); setCamButtonsLoading(true);
      try{
        const t=await getMainTime();
        const target = pdtAlignedTarget(t);
        await seekActiveTo(target);
      } finally {
        setTimeout(()=>setCamButtonsLoading(false),180);
        if(showBadge) setTimeout(()=>showSync(false),250);
      }
    }

    function startDriftCorrection(){
      stopDriftCorrection();
      driftTimer=setInterval(async()=>{
        try{
          const mt=await getMainTime();
          const atProm = (activePlayer && activePlayer.getCurrentTime) ? activePlayer.getCurrentTime() : Promise.resolve(activePlayer?.currentTime||0);
          const at = await atProm;
          const wMain = (SYNC.main.pdtOffset!=null)? SYNC.main.pdtOffset + (mt||0) : null;
          const wAct  = (SYNC.active.pdtOffset!=null)? SYNC.active.pdtOffset + (at||0) : null;
          const drift = (wMain!=null && wAct!=null) ? Math.abs(wAct - wMain) : Math.abs((at||0)-(mt||0));
          if(drift>0.28){ showSync(true); const target = pdtAlignedTarget(mt); await seekActiveTo(target); setTimeout(()=>showSync(false),250); }
        }catch(e){}
      }, 3500);
    }
    function stopDriftCorrection(){ if(driftTimer){ clearInterval(driftTimer); driftTimer=null; } }

    function showSync(v){ syncStatus.classList.toggle('hidden',!v); }
    function setCamButtonsLoading(s){ [...camControls.querySelectorAll('button')].forEach(b=>b.classList.toggle('loading',s)); }
    function setOneButtonLoading(btn,s){ if(btn) btn.classList.toggle('loading',s); }

    async function initDurations(){ const d=await getMainDuration(); scrub.max=(d&&isFinite(d))?d:0; }
    function fmt(t){ t=Math.max(0,Math.floor(t||0)); const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(t%60).padStart(2,'0'); return `${m}:${s}`; }
    let ticker=null, isScrubbing=false;
    function startTimeTicker(){ if(ticker) return; ticker=setInterval(async()=>{
      if(isScrubbing) return;
      const ct=await getMainTime();
      let d=await getMainDuration();
      if(mainPlayer instanceof HTMLVideoElement){
        const r=mainPlayer.seekable; if(r && r.length){ d=r.end(r.length-1)||d; }
      }
      if(d&&isFinite(d)) scrub.max=d; scrub.value=ct||0; timeLabel.textContent=`${fmt(ct)} / ${fmt(d||0)}`; },250); }
    function stopTimeTicker(){ if(ticker){ clearInterval(ticker); ticker=null; } }

    // ===== Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø­Ø³Ø¨ Ø§Ù„ØµÙˆØª =====
    async function reflectSoundState(){
      let muted = true;
      try{
        if(/vimeo\.com/i.test(sources.main) && mainPlayer && mainPlayer.getVolume){
          const v = await mainPlayer.getVolume();
          muted = (v === 0);
        } else if(/youtube\.com|youtu\.be/i.test(sources.main) && mainPlayer && mainPlayer.isMuted){
          muted = !!mainPlayer.isMuted();
        } else if(mainPlayer instanceof HTMLVideoElement){
          muted = !!mainPlayer.muted;
        }
      }catch(e){}
      btnSound.dataset.muted = String(muted);
      btnSound.setAttribute('aria-label', muted ? 'ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª' : 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª');
      btnSound.title = muted ? 'ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª' : 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª';
    }

    // ===== Ø²Ø± Ø§Ù„ØµÙˆØª Ù„Ù„Ù€ main =====
    async function toggleSound(){
      if(!started){ await startPlayback(); }

      if(/vimeo\.com/i.test(sources.main) && mainPlayer && mainPlayer.getVolume){
        try{
          const v=await mainPlayer.getVolume();
          if(v>0){ await mainPlayer.setVolume(0); }
          else { await mainPlayer.setVolume(1); await mainPlayer.play().catch(()=>{}); }
        }catch(e){}
        await reflectSoundState();
        return;
      }
      if(/youtube\.com|youtu\.be/i.test(sources.main) && mainPlayer && mainPlayer.isMuted){
        try{
          if(mainPlayer.isMuted()) mainPlayer.unMute(); else mainPlayer.mute();
          try{ mainPlayer.playVideo(); }catch(e){}
        }catch(e){}
        await reflectSoundState();
        return;
      }
      if(mainPlayer instanceof HTMLVideoElement){
        try{
          if(mainPlayer.muted){
            mainPlayer.muted = false;
            mainPlayer.volume = 1;
            await mainPlayer.play().catch(()=>{});
          }else{
            mainPlayer.muted = true;
          }
        }catch(e){}
        await reflectSoundState();
      }
    }

    async function togglePlayPause(){
      if(/vimeo\.com/i.test(sources.main) && mainPlayer && mainPlayer.getPaused){
        const p=await mainPlayer.getPaused().catch(()=>null); if(p===null) return;
        if(p){ await mainPlayer.play().catch(()=>{}); } else { await mainPlayer.pause().catch(()=>{}); }
        const mt=await getMainTime(); const target=pdtAlignedTarget(mt); await seekActiveTo(target); return;
      }
      if(/youtube\.com|youtu\.be/i.test(sources.main) && mainPlayer && mainPlayer.getPlayerState){
        const st=mainPlayer.getPlayerState(); if(st===1){ try{mainPlayer.pauseVideo()}catch(e){} } else { try{mainPlayer.playVideo()}catch(e){} }
        const mt=await getMainTime(); const target=pdtAlignedTarget(mt); await seekActiveTo(target); return;
      }
      if(mainPlayer instanceof HTMLVideoElement){
        if(mainPlayer.paused){ await mainPlayer.play().catch(()=>{}); } else { mainPlayer.pause(); }
        const mt=await getMainTime(); const target=pdtAlignedTarget(mt); await seekActiveTo(target);
      }
    }

    async function jumpBy(dlt){
      const t=await getMainTime(); const d=await getMainDuration();
      let nt=(t||0)+dlt; if(d&&isFinite(d)) nt=Math.min(Math.max(0,nt),d);
      showSync(true); await seekMainTo(nt); const target=pdtAlignedTarget(nt); await seekActiveTo(target); setTimeout(()=>showSync(false),250);
    }

    // ===== Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ù…Ø±Ù‘Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·) =====
    startBtn.addEventListener('click',startPlayback);
    mainContainer.addEventListener('click',toggleMainZoom);
    zoomBtn.addEventListener('click',toggleMainZoom);
    btnSplit.addEventListener('click',toggleSplitMode);
    btnFill.addEventListener('click',toggleFillMode);
    btnSound.addEventListener('click',toggleSound);
    camControls.addEventListener('click',(e)=>{ const btn=e.target.closest('button[data-cam]'); if(!btn) return; switchCam(btn.getAttribute('data-cam'),btn); });

    // ===== Ø¯ÙˆÙƒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„: ØªÙˆØ³ÙŠØ¹/ØªØµØºÙŠØ± Ø¨Ø§Ù„Ù†Ù‚Ø± (Ù…Ø¹ Ø³Ø­Ø¨ Ù„Ù„ØªÙ…Ø±ÙŠØ±) =====
    (function cameraDockInteraction(){
      const isPortrait = () => window.matchMedia('(orientation: portrait)').matches;
      const dock = document.getElementById('camControls');
      if(!dock) return;
      let touchStartX=0, touchStartY=0, moved=false;
      dock.addEventListener('touchstart', (e)=>{ if(!isPortrait()) return; const t=e.touches[0]; touchStartX=t.clientX; touchStartY=t.clientY; moved=false; }, {passive:true});
      dock.addEventListener('touchmove',  (e)=>{ if(!isPortrait()) return; const t=e.touches[0]; const dy=Math.abs(t.clientY-touchStartY); if(dy>6){ moved=true; } }, {passive:true});
      dock.addEventListener('touchend',   ()=>{ if(!isPortrait()) return; if(!moved){ dock.classList.toggle('expanded'); } });
      dock.addEventListener('click',      (e)=>{ if(!isPortrait()) return; if(e.target.closest('button')) return; dock.classList.toggle('expanded'); });
    })();

    // ØªÙ‡ÙŠØ¦Ø© Ù…Ø¤ÙƒØ¯Ø© Ø³ÙˆØ§Ø¡ ÙƒØ§Ù† Ø§Ù„Ù…ØµØ¯Ø± YouTube Ø£Ùˆ HLS/DASH
    window.onYouTubeIframeAPIReady = () => { initPlayersOnce(); };
    window.addEventListener('DOMContentLoaded', () => { initPlayersOnce(); });

    // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ¯ÙÙ‘Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ù„ÙÙŠØ©
    document.addEventListener('visibilitychange', ()=>{
      if(document.hidden){
        // ÙŠÙ…ÙƒÙ† Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø®ÙØ¶ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø¹Ø¨Ø± hls.currentLevel = ...
      }
    });

    /* fade-in buttons on activity */
    (function autoUi(){
      let t=null;
      const wake=()=>{ document.body.classList.add('ui-awake'); clearTimeout(t); t=setTimeout(()=>document.body.classList.remove('ui-awake'), 2200); };
      ['mousemove','touchstart','touchmove','keydown','click'].forEach(ev=>window.addEventListener(ev,wake,{passive:true}));
      wake();
    })();
  </script>
</body>
</html>
