<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Universal Multi-Cam Player (Optimized HLS - Fixed)</title>

  <!-- Players -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://player.vimeo.com/api/player.js"></script>

  <style>
    body {margin:0; background:#000; height:100vh; overflow:hidden;}
    #playerContainer{position:relative;width:100%;height:100%}
    .videoFrame{position:absolute;top:0;left:0;width:100%;height:100%;background:#000}
    #mainPreview{position:absolute;top:20px;right:20px;width:25%;height:25%;border:2px solid #fff;cursor:pointer;z-index:5}
    #camControls{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);z-index:6;}
    #camControls button{margin:3px;padding:8px 12px;background:#e53935;color:#fff;border:0;border-radius:8px;cursor:pointer}
    #gatePlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#000a;z-index:10}
    #gatePlay.hidden{display:none}
    #startBtn{padding:12px 20px;border-radius:10px;background:#e53935;color:#fff;border:0;font-weight:bold;cursor:pointer}
    #syncStatus{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);background:#000a;color:#fff;padding:6px 10px;border-radius:6px;z-index:7;}
    #syncStatus.hidden{display:none}
  </style>
</head>
<body>
  <div id="playerContainer">
    <div id="activeCam" class="videoFrame"></div>
    <div id="mainPreview" class="videoFrame"></div>
    <div id="gatePlay"><button id="startBtn">ابدأ التشغيل</button></div>
    <div id="camControls">
      <button data-cam="cam1">Cam1</button>
      <button data-cam="cam2">Cam2</button>
      <button data-cam="cam3">Cam3</button>
      <button data-cam="cam4">Cam4</button>
    </div>
    <div id="syncStatus" class="hidden">جاري المزامنة…</div>
  </div>

  <script>
    window.sources = {
      main:  `/hls/live/playlist.m3u8`,
      cam1:  `/hls/lastone/playlist.m3u8`,
      cam2:  `/hls/live2/playlist.m3u8`,
      cam3:  `/hls/live3/playlist.m3u8`,
      cam4:  `/hls/live4/playlist.m3u8`
    };

    let mainPlayer, activePlayer;
    let currentCam = "cam1";
    const mainContainer=document.getElementById('mainPreview');
    const camContainer=document.getElementById('activeCam');
    const gatePlay=document.getElementById('gatePlay');
    const startBtn=document.getElementById('startBtn');
    const camControls=document.getElementById('camControls');
    const syncStatus=document.getElementById('syncStatus');

    const hlsMap=new WeakMap();

    function destroyAttachedHls(videoEl){
      const inst=hlsMap.get(videoEl);
      if(inst){try{inst.destroy();}catch(e){} hlsMap.delete(videoEl);}
    }

    function clearContainer(c){
      while(c.firstChild){
        const n=c.firstChild;
        if(n.tagName==='VIDEO'){
          try{n.pause()}catch(e){}
          destroyAttachedHls(n);
        }
        c.removeChild(n);
      }
    }

    function attachHls(video,url,isMain=false){
      const cfg={
        enableWorker:true,
        lowLatencyMode:true,
        liveSyncDuration:isMain?2.5:3,
        liveMaxLatencyDuration:8,
        maxBufferLength:15,
        maxMaxBufferLength:30,
        maxBufferHole:0.1,
        capLevelToPlayerSize:true,
        xhrSetup:(xhr)=>{xhr.setRequestHeader('Cache-Control','no-cache');xhr.setRequestHeader('Pragma','no-cache');}
      };
      const hls=new Hls(cfg);
      hls.loadSource(url);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED,()=>video.play().catch(()=>{}));
      hls.on(Hls.Events.ERROR,(ev,data)=>{
        if(!data.fatal) return;
        if(data.type===Hls.ErrorTypes.NETWORK_ERROR){hls.startLoad();}
        else if(data.type===Hls.ErrorTypes.MEDIA_ERROR){hls.recoverMediaError();}
        else{destroyAttachedHls(video);attachHls(video,url,isMain);}
      });
      hlsMap.set(video,hls);
      return hls;
    }

    function createVideo(container,url,isMain=false){
      clearContainer(container);
      const video=document.createElement('video');
      video.autoplay=false;
      video.playsInline=true;
      video.controls=false;
      video.muted=true;
      video.style.width='100%';
      video.style.height='100%';
      container.appendChild(video);
      if(/\.m3u8($|\?)/i.test(url)&&window.Hls&&Hls.isSupported()){
        attachHls(video,url,isMain);
      } else {
        video.src=url;
      }
      return video;
    }

    function initPlayers(){
      if(!mainPlayer){
        mainPlayer=createVideo(mainContainer,sources.main,true);
      }
      activePlayer=createVideo(camContainer,sources[currentCam],false);
    }

    function startPlayback(){
      gatePlay.classList.add('hidden');
      if(mainPlayer && mainPlayer.play) mainPlayer.play().catch(()=>{});
      if(activePlayer && activePlayer.play) activePlayer.play().catch(()=>{});
    }

    function switchCam(cam,btn){
      currentCam=cam;
      activePlayer=createVideo(camContainer,sources[cam],false);
      if(activePlayer && activePlayer.play) activePlayer.play().catch(()=>{});
    }

    startBtn.addEventListener('click',startPlayback);
    camControls.addEventListener('click',(e)=>{
      const btn=e.target.closest('button[data-cam]');
      if(!btn) return;
      switchCam(btn.getAttribute('data-cam'),btn);
    });
    window.addEventListener('load',initPlayers);
  </script>
</body>
</html>
